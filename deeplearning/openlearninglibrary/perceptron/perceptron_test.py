# pylint: disable=too-many-lines
import numpy as np
from pytest import approx

from perceptron.perceptron import (
    averaged_perceptron,
    d_split_j,
    d_split_j_looper,
    eval_classifier,
    eval_learning_alg,
    perceptron,
    Data,
    Labels,
    Params,
    Hook,
    Theta,
    ThetaZero,
)


def plot_classifier(theta: Theta, theta_0=ThetaZero):
    print(theta, theta_0)


def test_perceptron():
    data: Data = np.array([[2, 3, 9, 12], [5, 1, 6, 5]])
    labels: Labels = np.array([[1, -1, 1, -1]])
    params: Params = {"T": 100}
    hook: Hook = plot_classifier
    classifier = perceptron(data=data, labels=labels, params=params, hook=hook)

    print([x.tolist() for x in classifier])

    np.array_equal(classifier[0], np.array([-9.0, 18.0]))
    assert classifier[1] == approx(2.0)


def test_averaged_perceptron():
    data: Data = np.array([[2, 3, 9, 12], [5, 1, 6, 5]])
    labels: Labels = np.array([[1, -1, 1, -1]])
    params: Params = {"T": 100}
    hook: Hook = plot_classifier
    classifier = averaged_perceptron(data=data, labels=labels, params=params, hook=hook)

    print([x.tolist() for x in classifier])

    np.array_equal(classifier[0], np.array([-9.0, 18.0]))
    assert classifier[1] == approx(1.9425)


def test_eval_classifier():
    data_train: Data = np.array([[2, 3, 9, 12], [5, 1, 6, 5]])
    labels_train: Labels = np.array([[1, -1, 1, -1]])
    data_test: Data = np.array([[2, 3, 9, 12], [5, 1, 6, 5]])
    labels_test: Labels = np.array([[1, -1, 1, 1]])

    assert eval_classifier(
        learner=perceptron,
        data_train=data_train,
        labels_train=labels_train,
        data_test=data_test,
        labels_test=labels_test,
    ) == approx(0.75)


def test_eval_learning_alg():
    data_train = np.array(
        [
            [
                -2.04297103,
                -1.85361169,
                -2.65467827,
                -1.23013149,
                -0.31934782,
                1.33112127,
                2.3297942,
                1.47705445,
                -1.9733787,
                -2.35476882,
            ],
            [
                -2.1071566,
                -3.06450052,
                -3.43898434,
                0.71320285,
                1.51214693,
                4.14295175,
                4.73681233,
                -2.80366981,
                1.56182223,
                0.07061724,
            ],
        ]
    )

    labels_train = np.array([[-1.0, -1.0, -1.0, 1.0, 1.0, -1.0, 1.0, -1.0, 1.0, -1.0]])

    data_test = np.array(
        [
            [
                -4.97193554,
                3.49851995,
                4.00302943,
                0.83369183,
                0.41371989,
                4.37614714,
                1.03536965,
                1.2354608,
                -0.7933465,
                -3.85456759,
            ],
            [
                -0.92053415,
                -3.61953464,
                0.39577344,
                -3.03202474,
                -4.90408303,
                -0.10239158,
                -1.35546287,
                1.31372748,
                -1.97924525,
                -3.72545813,
            ],
        ]
    )
    labels_test = np.array([[-1.0, -1.0, 1.0, 1.0, -1.0, 1.0, -1.0, -1.0, -1.0, 1.0]])

    def make_gen_data():
        progress = {"step": 0}

        def gen_data(size):
            _ = size
            gendata = (
                (data_train, labels_train)
                if progress["step"] == 0
                else (data_test, labels_test)
            )

            progress["step"] += 1
            return gendata

        return gen_data

    assert eval_learning_alg(
        learner=perceptron, data_gen=make_gen_data(), n_train=5, n_test=5, it=10
    ) == approx(0.55999999999999994)


def test_d_split_j():
    data = np.array(
        [
            [100 + i + 1 for i in range(60)],
            [200 + i + 1 for i in range(60)],
            [300 + i + 1 for i in range(60)],
        ]
    )
    d_j, d_minus_j = d_split_j(data, 5, 2)

    assert np.array_equal(
        d_j,
        np.array(
            [
                [125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136],
                [225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236],
                [325, 326, 327, 328, 329, 330, 331, 332, 333, 334, 335, 336],
            ]
        ),
    )

    assert np.array_equal(
        d_minus_j,
        np.array(
            [
                [
                    101,
                    102,
                    103,
                    104,
                    105,
                    106,
                    107,
                    108,
                    109,
                    110,
                    111,
                    112,
                    113,
                    114,
                    115,
                    116,
                    117,
                    118,
                    119,
                    120,
                    121,
                    122,
                    123,
                    124,
                    137,
                    138,
                    139,
                    140,
                    141,
                    142,
                    143,
                    144,
                    145,
                    146,
                    147,
                    148,
                    149,
                    150,
                    151,
                    152,
                    153,
                    154,
                    155,
                    156,
                    157,
                    158,
                    159,
                    160,
                ],
                [
                    201,
                    202,
                    203,
                    204,
                    205,
                    206,
                    207,
                    208,
                    209,
                    210,
                    211,
                    212,
                    213,
                    214,
                    215,
                    216,
                    217,
                    218,
                    219,
                    220,
                    221,
                    222,
                    223,
                    224,
                    237,
                    238,
                    239,
                    240,
                    241,
                    242,
                    243,
                    244,
                    245,
                    246,
                    247,
                    248,
                    249,
                    250,
                    251,
                    252,
                    253,
                    254,
                    255,
                    256,
                    257,
                    258,
                    259,
                    260,
                ],
                [
                    301,
                    302,
                    303,
                    304,
                    305,
                    306,
                    307,
                    308,
                    309,
                    310,
                    311,
                    312,
                    313,
                    314,
                    315,
                    316,
                    317,
                    318,
                    319,
                    320,
                    321,
                    322,
                    323,
                    324,
                    337,
                    338,
                    339,
                    340,
                    341,
                    342,
                    343,
                    344,
                    345,
                    346,
                    347,
                    348,
                    349,
                    350,
                    351,
                    352,
                    353,
                    354,
                    355,
                    356,
                    357,
                    358,
                    359,
                    360,
                ],
            ]
        ),
    )

    d_j_2, d_minus_j_2 = d_split_j(np.array([[11, 12, 13], [21, 22, 23]]), 1, 0)
    assert np.array_equal(d_j_2, np.array([[11, 12, 13], [21, 22, 23]]))
    assert np.array_equal(d_minus_j_2, np.ndarray((2, 0)))


def test_d_split_j_looper_demo():
    data = np.array(
        [
            [100 + i + 1 for i in range(60)],
            [200 + i + 1 for i in range(60)],
        ]
    )
    print("[")
    for dataj, dminusj in d_split_j_looper(data, 5):
        print("(")
        print(repr(dataj))
        print(",")
        print(repr(dminusj))
        print("),")
    print("]")

    actual = list(d_split_j_looper(data, 5))
    expected = [
        (
            np.array(
                [
                    [
                        101,
                        102,
                        103,
                        104,
                        105,
                        106,
                        107,
                        108,
                        109,
                        110,
                        111,
                        112,
                    ],
                    [
                        201,
                        202,
                        203,
                        204,
                        205,
                        206,
                        207,
                        208,
                        209,
                        210,
                        211,
                        212,
                    ],
                ]
            ),
            np.array(
                [
                    [
                        113,
                        114,
                        115,
                        116,
                        117,
                        118,
                        119,
                        120,
                        121,
                        122,
                        123,
                        124,
                        125,
                        126,
                        127,
                        128,
                        129,
                        130,
                        131,
                        132,
                        133,
                        134,
                        135,
                        136,
                        137,
                        138,
                        139,
                        140,
                        141,
                        142,
                        143,
                        144,
                        145,
                        146,
                        147,
                        148,
                        149,
                        150,
                        151,
                        152,
                        153,
                        154,
                        155,
                        156,
                        157,
                        158,
                        159,
                        160,
                    ],
                    [
                        213,
                        214,
                        215,
                        216,
                        217,
                        218,
                        219,
                        220,
                        221,
                        222,
                        223,
                        224,
                        225,
                        226,
                        227,
                        228,
                        229,
                        230,
                        231,
                        232,
                        233,
                        234,
                        235,
                        236,
                        237,
                        238,
                        239,
                        240,
                        241,
                        242,
                        243,
                        244,
                        245,
                        246,
                        247,
                        248,
                        249,
                        250,
                        251,
                        252,
                        253,
                        254,
                        255,
                        256,
                        257,
                        258,
                        259,
                        260,
                    ],
                ]
            ),
        ),
        (
            np.array(
                [
                    [
                        113,
                        114,
                        115,
                        116,
                        117,
                        118,
                        119,
                        120,
                        121,
                        122,
                        123,
                        124,
                    ],
                    [
                        213,
                        214,
                        215,
                        216,
                        217,
                        218,
                        219,
                        220,
                        221,
                        222,
                        223,
                        224,
                    ],
                ]
            ),
            np.array(
                [
                    [
                        101,
                        102,
                        103,
                        104,
                        105,
                        106,
                        107,
                        108,
                        109,
                        110,
                        111,
                        112,
                        125,
                        126,
                        127,
                        128,
                        129,
                        130,
                        131,
                        132,
                        133,
                        134,
                        135,
                        136,
                        137,
                        138,
                        139,
                        140,
                        141,
                        142,
                        143,
                        144,
                        145,
                        146,
                        147,
                        148,
                        149,
                        150,
                        151,
                        152,
                        153,
                        154,
                        155,
                        156,
                        157,
                        158,
                        159,
                        160,
                    ],
                    [
                        201,
                        202,
                        203,
                        204,
                        205,
                        206,
                        207,
                        208,
                        209,
                        210,
                        211,
                        212,
                        225,
                        226,
                        227,
                        228,
                        229,
                        230,
                        231,
                        232,
                        233,
                        234,
                        235,
                        236,
                        237,
                        238,
                        239,
                        240,
                        241,
                        242,
                        243,
                        244,
                        245,
                        246,
                        247,
                        248,
                        249,
                        250,
                        251,
                        252,
                        253,
                        254,
                        255,
                        256,
                        257,
                        258,
                        259,
                        260,
                    ],
                ]
            ),
        ),
        (
            np.array(
                [
                    [
                        125,
                        126,
                        127,
                        128,
                        129,
                        130,
                        131,
                        132,
                        133,
                        134,
                        135,
                        136,
                    ],
                    [
                        225,
                        226,
                        227,
                        228,
                        229,
                        230,
                        231,
                        232,
                        233,
                        234,
                        235,
                        236,
                    ],
                ]
            ),
            np.array(
                [
                    [
                        101,
                        102,
                        103,
                        104,
                        105,
                        106,
                        107,
                        108,
                        109,
                        110,
                        111,
                        112,
                        113,
                        114,
                        115,
                        116,
                        117,
                        118,
                        119,
                        120,
                        121,
                        122,
                        123,
                        124,
                        137,
                        138,
                        139,
                        140,
                        141,
                        142,
                        143,
                        144,
                        145,
                        146,
                        147,
                        148,
                        149,
                        150,
                        151,
                        152,
                        153,
                        154,
                        155,
                        156,
                        157,
                        158,
                        159,
                        160,
                    ],
                    [
                        201,
                        202,
                        203,
                        204,
                        205,
                        206,
                        207,
                        208,
                        209,
                        210,
                        211,
                        212,
                        213,
                        214,
                        215,
                        216,
                        217,
                        218,
                        219,
                        220,
                        221,
                        222,
                        223,
                        224,
                        237,
                        238,
                        239,
                        240,
                        241,
                        242,
                        243,
                        244,
                        245,
                        246,
                        247,
                        248,
                        249,
                        250,
                        251,
                        252,
                        253,
                        254,
                        255,
                        256,
                        257,
                        258,
                        259,
                        260,
                    ],
                ]
            ),
        ),
        (
            np.array(
                [
                    [
                        137,
                        138,
                        139,
                        140,
                        141,
                        142,
                        143,
                        144,
                        145,
                        146,
                        147,
                        148,
                    ],
                    [
                        237,
                        238,
                        239,
                        240,
                        241,
                        242,
                        243,
                        244,
                        245,
                        246,
                        247,
                        248,
                    ],
                ]
            ),
            np.array(
                [
                    [
                        101,
                        102,
                        103,
                        104,
                        105,
                        106,
                        107,
                        108,
                        109,
                        110,
                        111,
                        112,
                        113,
                        114,
                        115,
                        116,
                        117,
                        118,
                        119,
                        120,
                        121,
                        122,
                        123,
                        124,
                        125,
                        126,
                        127,
                        128,
                        129,
                        130,
                        131,
                        132,
                        133,
                        134,
                        135,
                        136,
                        149,
                        150,
                        151,
                        152,
                        153,
                        154,
                        155,
                        156,
                        157,
                        158,
                        159,
                        160,
                    ],
                    [
                        201,
                        202,
                        203,
                        204,
                        205,
                        206,
                        207,
                        208,
                        209,
                        210,
                        211,
                        212,
                        213,
                        214,
                        215,
                        216,
                        217,
                        218,
                        219,
                        220,
                        221,
                        222,
                        223,
                        224,
                        225,
                        226,
                        227,
                        228,
                        229,
                        230,
                        231,
                        232,
                        233,
                        234,
                        235,
                        236,
                        249,
                        250,
                        251,
                        252,
                        253,
                        254,
                        255,
                        256,
                        257,
                        258,
                        259,
                        260,
                    ],
                ]
            ),
        ),
        (
            np.array(
                [
                    [
                        149,
                        150,
                        151,
                        152,
                        153,
                        154,
                        155,
                        156,
                        157,
                        158,
                        159,
                        160,
                    ],
                    [
                        249,
                        250,
                        251,
                        252,
                        253,
                        254,
                        255,
                        256,
                        257,
                        258,
                        259,
                        260,
                    ],
                ]
            ),
            np.array(
                [
                    [
                        101,
                        102,
                        103,
                        104,
                        105,
                        106,
                        107,
                        108,
                        109,
                        110,
                        111,
                        112,
                        113,
                        114,
                        115,
                        116,
                        117,
                        118,
                        119,
                        120,
                        121,
                        122,
                        123,
                        124,
                        125,
                        126,
                        127,
                        128,
                        129,
                        130,
                        131,
                        132,
                        133,
                        134,
                        135,
                        136,
                        137,
                        138,
                        139,
                        140,
                        141,
                        142,
                        143,
                        144,
                        145,
                        146,
                        147,
                        148,
                    ],
                    [
                        201,
                        202,
                        203,
                        204,
                        205,
                        206,
                        207,
                        208,
                        209,
                        210,
                        211,
                        212,
                        213,
                        214,
                        215,
                        216,
                        217,
                        218,
                        219,
                        220,
                        221,
                        222,
                        223,
                        224,
                        225,
                        226,
                        227,
                        228,
                        229,
                        230,
                        231,
                        232,
                        233,
                        234,
                        235,
                        236,
                        237,
                        238,
                        239,
                        240,
                        241,
                        242,
                        243,
                        244,
                        245,
                        246,
                        247,
                        248,
                    ],
                ]
            ),
        ),
    ]
    for act, exp in zip(actual, expected):
        assert np.array_equal(act[0], exp[0])
        assert np.array_equal(act[1], exp[1])
